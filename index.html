<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ–°å¹´åäºŒç”Ÿè‚–æ”¶é›†æ´»å‹•</title>
  <style>
    :root{
      --bg:#0f1020;
      --card:#16182b;
      --text:#ffffff;
      --muted:#cbd5e1;
      --accent:#ff3b3b;
      --gold:#f5c452;
      --border:#25304a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans TC","Segoe UI",system-ui,-apple-system, sans-serif;
      background: radial-gradient(1000px 500px at 80% -10%, #1b1e33 0%, var(--bg) 45%, #0a0b17 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .page {
      max-width:1080px;
      margin:28px auto;
      padding:24px;
    }

    /* Tabs */
    .tabs {
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
    }
    .tab-btn {
      background:transparent;
      border:1px solid transparent;
      color:var(--muted);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    .tab-btn[aria-selected="true"]{
      color: #1b0a0a;
      background: linear-gradient(90deg,#ff7a7a,#ffd06e);
      box-shadow: 0 8px 20px rgba(255,120,120,0.12);
      border-color: rgba(255,255,255,0.06);
    }

    /* Header area inside tab content */
    .header {
      display:grid;
      grid-template-columns: 1fr auto;
      gap:16px;
      align-items:center;
      margin-bottom:18px;
    }
    .title h1{
      margin:0;
      font-size:26px;
      background: linear-gradient(90deg,#ff7a7a,#ffd06e);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
    }

    .controls {
      display:flex;
      gap:12px;
      align-items:center;
    }

    .cost-box{
      background: linear-gradient(180deg,#2a1b1b,#1a0f0f);
      border:1px solid rgba(255,255,255,0.04);
      padding:10px 14px;
      border-radius:12px;
      min-width:150px;
      text-align:left;
    }
    .cost-box .label{ font-size:12px; color:var(--muted); }
    .cost-box .amount{ margin-top:6px; font-weight:800; font-size:16px; color:#ffd9a8; }

    .btn-group{ display:flex; gap:10px; }

    .cta{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:linear-gradient(90deg,#ff5d5d,#ff9f5a);
      color:#1b0a0a;
      font-weight:800;
      border:none;
      border-radius:999px;
      padding:10px 16px;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(255,95,95,0.18);
    }
    .cta:disabled{ opacity:0.6; cursor:not-allowed; transform:none; box-shadow:none; }

    /* Card and grid */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.28);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:14px;
      margin-top:14px;
    }
    .zodiac{
      background: linear-gradient(180deg,#1c2038,#151831);
      border:1px solid #2a3355;
      border-radius:14px;
      padding:12px 8px;
      text-align:center;
      position:relative;
    }
    .chip{
      position:absolute;
      top:8px;
      left:8px;
      background: rgba(255,255,255,0.04);
      color:var(--muted);
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.06);
    }
    .icon{ font-size:28px; margin:8px 0 6px; }
    .name{ font-size:14px; font-weight:700; color:#e6ecff; }
    .note{ font-size:12px; color:var(--muted); margin-top:6px; }

    /* Second tab content */
    .record {
      display:flex;
      gap:18px;
      margin-top:12px;
      align-items:flex-start;
    }
    .counts {
      min-width:260px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
    }
    .counts h3{ margin:0 0 8px 0; font-size:14px; color:#e6ecff; }
    .counts-list{ display:grid; grid-template-columns:1fr 1fr; gap:6px; font-size:13px; color:var(--muted); }

    /* æ–°å¢ï¼šç›®å‰å…Œæ›æ•¸é‡ panel */
    .exchange-counts {
      margin-top:12px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
    }
    .exchange-counts h3 { margin:0 0 8px 0; font-size:14px; color:#ffdca8; }
    .exchange-counts-list { display:grid; grid-template-columns:1fr; gap:6px; font-size:13px; color:var(--muted); }

    .history {
      flex:1;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      max-height:320px;
      overflow:auto;
    }
    .history h3{ margin:0 0 8px 0; font-size:14px; color:#e6ecff; }
    .history-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; }
    .history-item{ font-size:13px; color:var(--muted); padding:8px; border-radius:8px; background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); }

    /* Exchange tab */
    .exchange-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:14px; margin-top:12px; }
    .box {
      background: linear-gradient(180deg,#162033,#0f1524);
      border:1px solid #24324f;
      border-radius:12px;
      padding:12px;
    }
    .box h3 { margin:0 0 8px 0; color:#ffdca8; }
    .box p { margin:0 0 10px 0; color:var(--muted); font-size:13px; }
    .box .rewards { display:flex; gap:8px; flex-wrap:wrap; }
    .reward { background:rgba(255,255,255,0.02); padding:6px 8px; border-radius:8px; font-size:13px; color:var(--muted); border:1px solid rgba(255,255,255,0.02); }

    .exchange-result {
      margin-top:12px;
      padding:12px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
      border:1px solid var(--border);
      border-radius:12px;
      color:var(--muted);
    }

    footer{ margin-top:18px; color:var(--muted); font-size:13px; text-align:center; }

    @media (max-width:900px){
      .grid{ grid-template-columns: repeat(4,1fr); }
      .header{ grid-template-columns:1fr; }
      .controls{ justify-content:flex-start; }
      .exchange-grid{ grid-template-columns: 1fr; }
    }
    @media (max-width:560px){
      .grid{ grid-template-columns: repeat(3,1fr); }
      .record{ flex-direction:column; }
      .counts{ width:100%; }
    }
  </style>
</head>
<body>
  <div class="page" id="app">
    <!-- Tabs -->
    <div class="tabs" role="tablist" aria-label="é ç±¤">
      <button class="tab-btn" role="tab" aria-selected="true" id="tab-activity">æ´»å‹•</button>
      <button class="tab-btn" role="tab" aria-selected="false" id="tab-record">ç´€éŒ„</button>
      <button class="tab-btn" role="tab" aria-selected="false" id="tab-exchange">å…Œæ›</button>
    </div>

    <!-- Tab panels -->
    <section id="panel-activity" role="tabpanel" aria-labelledby="tab-activity">
      <div class="header">
        <div class="title">
          <h1>æ–°å¹´åäºŒç”Ÿè‚–æ”¶é›†æ´»å‹•</h1>
          <p class="subtitle" id="subtitle">æŒ‰ä¸‹æŒ‰éˆ•é–‹å§‹æŠ½å–ç”Ÿè‚–ï¼</p>
        </div>

        <div class="controls" aria-hidden="false">
          <div class="cost-box" aria-live="polite" aria-atomic="true">
            <div class="label">ç¸½èŠ±è²»</div>
            <div class="amount" id="totalCost">0å…ƒ</div>
          </div>

          <div class="btn-group" role="group" aria-label="æŠ½å–æŒ‰éˆ•">
            <button class="cta" id="newYearBtn">ğŸ‹ æ–°å¹´çš„æ°£æ¯</button>
            <button class="cta" id="newYearBtn10">ğŸ‹ æ–°å¹´çš„æ°£æ¯*10</button>
            <button class="cta" id="newYearBtn100">ğŸ‹ æ–°å¹´çš„æ°£æ¯*100</button>
          </div>
        </div>
      </div>

      <div class="card" aria-live="polite">
        <div class="grid" id="zodiacGrid" role="list" aria-label="åäºŒç”Ÿè‚–">
          <div class="zodiac" role="listitem"><span class="chip">ç‰›</span><div class="icon">ğŸ‚</div><div class="name">ç‰›</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">è™</span><div class="icon">ğŸ¯</div><div class="name">è™</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">å…”</span><div class="icon">ğŸ°</div><div class="name">å…”</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">é¾</span><div class="icon">ğŸ‰</div><div class="name">é¾</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">è›‡</span><div class="icon">ğŸ</div><div class="name">è›‡</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">é¦¬</span><div class="icon">ğŸ´</div><div class="name">é¦¬</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">ç¾Š</span><div class="icon">ğŸ</div><div class="name">ç¾Š</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">çŒ´</span><div class="icon">ğŸµ</div><div class="name">çŒ´</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">é›</span><div class="icon">ğŸ”</div><div class="name">é›</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">ç‹—</span><div class="icon">ğŸ¶</div><div class="name">ç‹—</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">è±¬</span><div class="icon">ğŸ·</div><div class="name">è±¬</div><div class="note">0å€‹</div></div>
          <div class="zodiac" role="listitem"><span class="chip">é¼ </span><div class="icon">ğŸ­</div><div class="name">é¼ </div><div class="note">0å€‹</div></div>
        </div>

        <div style="margin-top:18px; display:flex; gap:12px; align-items:center;">
          <div style="flex:1; color:var(--muted); font-size:13px;">
            æ”¶é›†ä¸åŒçš„åäºŒç”Ÿè‚–æ°£æ¯ 3 / 6 / 9 / 12 å€‹å°±èƒ½äº¤æ›å……æ»¿ç‰¹åˆ¥çå‹µçš„å¿ƒé¡˜ç®±ã€‚<span id="ownedDistinct" style="color:#ffdca8; font-weight:700;">ç›®å‰æŒæœ‰0ç¨®ç”Ÿè‚–</span>
          </div>
          <button class="cta" id="redeemBtn" style="background:linear-gradient(90deg,#ffd06e,#ffb86b); color:#2b1200; font-weight:800;">å…Œæ›å¿ƒé¡˜ç®±</button>
        </div>
      </div>
    </section>

    <section id="panel-record" role="tabpanel" aria-labelledby="tab-record" hidden>
      <div class="card">
        <div class="record">
          <div style="display:flex; flex-direction:column; gap:12px;">
            <div class="counts" aria-hidden="false">
              <h3>ç›®å‰æ”¶é›†æ•¸é‡</h3>
              <div class="counts-list" id="countsList"></div>
            </div>

            <!-- æ–°å¢ panelï¼šç›®å‰å…Œæ›æ•¸é‡ -->
            <div class="exchange-counts" id="exchangeCountsPanel">
              <h3>ç›®å‰å…Œæ›æ•¸é‡</h3>
              <div class="exchange-counts-list" id="exchangeCountsList"></div>
            </div>
          </div>

          <div class="history" aria-live="polite">
            <h3>æŠ½å–ç´€éŒ„</h3>
            <ul class="history-list" id="historyList"></ul>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
          <button class="cta" id="clearHistory">æ¸…é™¤ç´€éŒ„</button>
          <div style="color:var(--muted); font-size:13px;">ç¸½èŠ±è²»ï¼š<strong id="summaryCost">0å…ƒ</strong></div>
        </div>
      </div>
    </section>

    <section id="panel-exchange" role="tabpanel" aria-labelledby="tab-exchange" hidden>
      <div class="card">
        <h2 style="margin:0 0 8px 0; color:#ffdca8;">å…Œæ›å¿ƒé¡˜ç®±</h2>
        <p style="margin:0 0 12px 0; color:var(--muted);">ä½¿ç”¨ä½ æŒæœ‰çš„ä¸åŒç”Ÿè‚–æ°£æ¯æ¶ˆè€—æŒ‡å®šæ•¸é‡ä»¥é–‹å•Ÿå°æ‡‰ç­‰ç´šçš„å¿ƒé¡˜ç®±ã€‚</p>

        <div class="exchange-grid" id="exchangeGrid">
          <div class="box" id="box-super">
            <h3>è¶…è¶Šç­‰ç´šç®±å­ï¼ˆéœ€ 12 ç¨®ä¸åŒç”Ÿè‚–ï¼‰</h3>
            <p>æ¶ˆè€— 12 ç¨®ä¸åŒç”Ÿè‚–ä»¥é–‹å•Ÿï¼Œçå‹µï¼ˆæ©Ÿç‡ç›¸ç­‰ï¼‰ï¼š</p>
            <div class="rewards">
              <div class="reward">è¼ªè¿´ç¢‘çŸ³ â€” 33.33%</div>
              <div class="reward">ç‡ƒç‡’ä¹‹æˆ’ â€” 33.33%</div>
              <div class="reward">è‹¦è¡Œçš„æˆ’æŒ‡ â€” 33.33%</div>
            </div>
            <div style="margin-top:10px;">
              <button class="cta" data-require="12" data-box="super" id="exchangeSuper">å…Œæ›è¶…è¶Šç®±</button>
            </div>
          </div>

          <div class="box" id="box-great">
            <h3>å¤§å‰ç­‰ç´šç®±å­ï¼ˆéœ€ 9 ç¨®ä¸åŒç”Ÿè‚–ï¼‰</h3>
            <p>æ¶ˆè€— 9 ç¨®ä¸åŒç”Ÿè‚–ä»¥é–‹å•Ÿï¼Œçå‹µï¼ˆæ©Ÿç‡ç›¸ç­‰ï¼‰ï¼š</p>
            <div class="rewards">
              <div class="reward">é­”æ³•è³¦äºˆç¬¬3éšæ®µè³¦äºˆå·è»¸ â€” 33.33%</div>
              <div class="reward">æ™‚è£å…§è¥¯1ç¨®é¸æ“‡åˆ¸ â€” 33.33%</div>
              <div class="reward">é­”æ³•éˆæ°£30å€‹äº¤æ›åˆ¸ â€” 33.33%</div>
            </div>
            <div style="margin-top:10px;">
              <button class="cta" data-require="9" data-box="great" id="exchangeGreat">å…Œæ›å¤§å‰ç®±</button>
            </div>
          </div>

          <div class="box" id="box-medium">
            <h3>ä¸­å‰ç­‰ç´šç®±å­ï¼ˆéœ€ 6 ç¨®ä¸åŒç”Ÿè‚–ï¼‰</h3>
            <p>æ¶ˆè€— 6 ç¨®ä¸åŒç”Ÿè‚–ä»¥é–‹å•Ÿï¼Œçå‹µï¼ˆæ©Ÿç‡ç›¸ç­‰ï¼‰ï¼š</p>
            <div class="rewards">
              <div class="reward">é«˜ç´šè‡ªå®šç¾©çš®è†šè®Šæ›´åˆ¸äº¤æ›åˆ¸ â€” 33.33%</div>
              <div class="reward">å½©è‰²ç¨œé¡Proäº¤æ›åˆ¸ â€” 33.33%</div>
              <div class="reward">è‡ªç”±é€ å‹åˆ¸ 10å€‹ â€” 33.33%</div>
            </div>
            <div style="margin-top:10px;">
              <button class="cta" data-require="6" data-box="medium" id="exchangeMedium">å…Œæ›ä¸­å‰ç®±</button>
            </div>
          </div>

          <div class="box" id="box-small">
            <h3>å°å‰ç­‰ç´šç®±å­ï¼ˆéœ€ 3 ç¨®ä¸åŒç”Ÿè‚–ï¼‰</h3>
            <p>æ¶ˆè€— 3 ç¨®ä¸åŒç”Ÿè‚–ä»¥é–‹å•Ÿï¼Œçå‹µï¼ˆæ©Ÿç‡ç›¸ç­‰ï¼‰ï¼š</p>
            <div class="rewards">
              <div class="reward">é–ƒç‚«æ–¹å¡Š â€” 33.33%</div>
              <div class="reward">æ¢å¾©é™„åŠ æ–¹å¡Š â€” 33.33%</div>
              <div class="reward">æ¢å¾©æ–¹å¡Š â€” 33.33%</div>
            </div>
            <div style="margin-top:10px;">
              <button class="cta" data-require="3" data-box="small" id="exchangeSmall">å…Œæ›å°å‰ç®±</button>
            </div>
          </div>
        </div>

        <div class="exchange-result" id="exchangeResult" aria-live="polite">
          å°šæœªå…Œæ›ï¼Œè«‹é¸æ“‡ä¸€å€‹ç®±å­ä¸¦ç¢ºèªä½ æŒæœ‰è¶³å¤ çš„ä¸åŒç”Ÿè‚–ã€‚
        </div>
      </div>
    </section>

    <footer>ç¥ä½ æ–°å¹´å¹³å®‰å–œæ¨‚ï¼Œå¿ƒæƒ³äº‹æˆï¼</footer>
  </div>

  <script>
    // Constants and DOM
    const COST_PER_DRAW = 27;
    const btn = document.getElementById('newYearBtn');
    const btn10 = document.getElementById('newYearBtn10');
    const btn100 = document.getElementById('newYearBtn100');
    const zodiacItems = document.querySelectorAll('#zodiacGrid .zodiac');
    const subtitle = document.getElementById('subtitle');
    const totalCostEl = document.getElementById('totalCost');
    const historyListEl = document.getElementById('historyList');
    const countsListEl = document.getElementById('countsList');
    const summaryCostEl = document.getElementById('summaryCost');
    const clearHistoryBtn = document.getElementById('clearHistory');
    const exchangeResultEl = document.getElementById('exchangeResult');
    const exchangeCountsListEl = document.getElementById('exchangeCountsList');
    const ownedDistinctEl = document.getElementById('ownedDistinct');

    // Tabs
    const tabActivity = document.getElementById('tab-activity');
    const tabRecord = document.getElementById('tab-record');
    const tabExchange = document.getElementById('tab-exchange');
    const panelActivity = document.getElementById('panel-activity');
    const panelRecord = document.getElementById('panel-record');
    const panelExchange = document.getElementById('panel-exchange');

    tabActivity.addEventListener('click', () => {
      tabActivity.setAttribute('aria-selected','true');
      tabRecord.setAttribute('aria-selected','false');
      tabExchange.setAttribute('aria-selected','false');
      panelActivity.hidden = false;
      panelRecord.hidden = true;
      panelExchange.hidden = true;
    });
    tabRecord.addEventListener('click', () => {
      tabActivity.setAttribute('aria-selected','false');
      tabRecord.setAttribute('aria-selected','true');
      tabExchange.setAttribute('aria-selected','false');
      panelActivity.hidden = true;
      panelRecord.hidden = false;
      panelExchange.hidden = true;
      renderCounts();
      renderExchangeCounts();
      renderSummaryCost();
      renderHistory();
    });
    tabExchange.addEventListener('click', () => {
      tabActivity.setAttribute('aria-selected','false');
      tabRecord.setAttribute('aria-selected','false');
      tabExchange.setAttribute('aria-selected','true');
      panelActivity.hidden = true;
      panelRecord.hidden = true;
      panelExchange.hidden = false;
      renderCounts();
      renderExchangeCounts();
      renderSummaryCost();
      renderHistory();
    });

    // Probabilities (as decimals)
    const probabilities = {
      "é¦¬": 0.0015,
      "ç¾Š": 0.0020,
      "çŒ´": 0.0025,
      "é›": 0.0080,
      "ç‹—": 0.0090,
      "è±¬": 0.0100,
      "é¼ ": 0.0250,
      "ç‰›": 0.0300,
      "è™": 0.0350,
      "å…”": 0.2920,
      "é¾": 0.2925,
      "è›‡": 0.2925
    };

    // Build cumulative distribution
    const cumulative = [];
    (function buildCumulative(){
      let sum = 0;
      for (const [name, prob] of Object.entries(probabilities)) {
        sum += prob;
        cumulative.push({ name, threshold: sum });
      }
      cumulative[cumulative.length - 1].threshold = 1;
    })();

    function weightedDrawName(){
      const r = Math.random();
      for (const item of cumulative) {
        if (r <= item.threshold) return item.name;
      }
      return cumulative[cumulative.length - 1].name;
    }

    // State
    let totalCost = 0;
    const history = []; // æ¯æ¬¡æŠ½å–æˆ–å…Œæ›çš„ç´€éŒ„ï¼ˆç‰©ä»¶ï¼‰
    const counts = {};  // å„ç”Ÿè‚–æ•¸é‡
    const rewardsCounts = {}; // å„çå“ç²å¾—æ•¸é‡

    // åˆå§‹åŒ– counts ç‚º 0
    Array.from(zodiacItems).forEach(item => {
      const name = item.querySelector('.name').textContent;
      counts[name] = 0;
    });

    // Box definitions and rewards
    const boxDefinitions = {
      super: {
        require: 12,
        rewards: ['è¼ªè¿´ç¢‘çŸ³', 'ç‡ƒç‡’ä¹‹æˆ’', 'è‹¦è¡Œçš„æˆ’æŒ‡']
      },
      great: {
        require: 9,
        rewards: ['é­”æ³•è³¦äºˆç¬¬3éšæ®µè³¦äºˆå·è»¸', 'æ™‚è£å…§è¥¯1ç¨®é¸æ“‡åˆ¸', 'é­”æ³•éˆæ°£30å€‹äº¤æ›åˆ¸']
      },
      medium: {
        require: 6,
        rewards: ['é«˜ç´šè‡ªå®šç¾©çš®è†šè®Šæ›´åˆ¸äº¤æ›åˆ¸', 'å½©è‰²ç¨œé¡Proäº¤æ›åˆ¸', 'è‡ªç”±é€ å‹åˆ¸ 10å€‹']
      },
      small: {
        require: 3,
        rewards: ['é–ƒç‚«æ–¹å¡Š', 'æ¢å¾©é™„åŠ æ–¹å¡Š', 'æ¢å¾©æ–¹å¡Š']
      }
    };

    // Initialize rewardsCounts keys
    (function initRewardsCounts(){
      for (const boxKey of Object.keys(boxDefinitions)) {
        for (const r of boxDefinitions[boxKey].rewards) {
          rewardsCounts[r] = 0;
        }
      }
    })();

    // Helpers
    function formatCurrency(n){ return `${n}å…ƒ`; }
    function increaseCost(times){
      totalCost += COST_PER_DRAW * times;
      totalCostEl.textContent = formatCurrency(totalCost);
    }
    function updateZodiacCount(name){
      counts[name] = (counts[name] || 0) + 1;
      const selected = Array.from(zodiacItems).find(item => item.querySelector('.name').textContent === name);
      if (selected) selected.querySelector('.note').textContent = `${counts[name]}å€‹`;
      updateOwnedDistinctDisplay();
    }
    function decreaseZodiacCount(name){
      if (!counts[name] || counts[name] <= 0) return false;
      counts[name] = counts[name] - 1;
      const selected = Array.from(zodiacItems).find(item => item.querySelector('.name').textContent === name);
      if (selected) selected.querySelector('.note').textContent = `${counts[name]}å€‹`;
      updateOwnedDistinctDisplay();
      return true;
    }
    function pushHistory(entry){
      history.unshift(entry);
      if (history.length > 500) history.pop();
    }

    function renderHistory(){
      historyListEl.innerHTML = '';
      if (history.length === 0) {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.textContent = 'å°šç„¡æŠ½å–ç´€éŒ„';
        historyListEl.appendChild(li);
        return;
      }
      for (const h of history) {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.textContent = `${h.time} â€” ${h.type}ï¼š${h.name}`;
        historyListEl.appendChild(li);
      }
    }

    function renderCounts(){
      countsListEl.innerHTML = '';
      Array.from(zodiacItems).forEach(item => {
        const name = item.querySelector('.name').textContent;
        const div = document.createElement('div');
        div.textContent = `${name}ï¼š${counts[name] || 0}å€‹`;
        countsListEl.appendChild(div);
      });
      updateOwnedDistinctDisplay();
    }

    // æ¸²æŸ“ç›®å‰å…Œæ›æ•¸é‡ï¼ˆå¿ƒé¡˜ç®±çå“åŠç›®å‰æŠ½åˆ°çš„æ•¸é‡ï¼‰
    function renderExchangeCounts(){
      exchangeCountsListEl.innerHTML = '';
      for (const boxKey of ['super','great','medium','small']) {
        const box = boxDefinitions[boxKey];
        const header = document.createElement('div');
        header.style.fontWeight = '700';
        header.style.marginTop = '6px';
        header.textContent = `${boxKey === 'super' ? 'è¶…è¶Š' : boxKey === 'great' ? 'å¤§å‰' : boxKey === 'medium' ? 'ä¸­å‰' : 'å°å‰'} ç­‰ç´šç®±å­ çå“ï¼š`;
        exchangeCountsListEl.appendChild(header);
        for (const r of box.rewards) {
          const row = document.createElement('div');
          row.textContent = `${r}ï¼š${rewardsCounts[r] || 0} å€‹`;
          exchangeCountsListEl.appendChild(row);
        }
      }
    }

    function renderSummaryCost(){
      summaryCostEl.textContent = formatCurrency(totalCost);
    }

    function getOwnedDistinctNames(){
      return Object.keys(counts).filter(name => counts[name] > 0);
    }

    function updateOwnedDistinctDisplay(){
      const distinct = getOwnedDistinctNames().length;
      ownedDistinctEl.textContent = `ç›®å‰æŒæœ‰${distinct}ç¨®ç”Ÿè‚–`;
    }

    // Exchange buttons collection (used by withTemporaryDisable)
    const exchangeButtons = [
      document.getElementById('exchangeSuper'),
      document.getElementById('exchangeGreat'),
      document.getElementById('exchangeMedium'),
      document.getElementById('exchangeSmall')
    ];

    // Prevent rapid double clicks
    function withTemporaryDisable(fn, ms = 50){
      return function(...args){
        btn.disabled = true;
        btn10.disabled = true;
        btn100.disabled = true;
        exchangeButtons.forEach(b => { if (b) b.disabled = true; });
        try { fn(...args); } finally {
          setTimeout(() => {
            btn.disabled = false;
            btn10.disabled = false;
            btn100.disabled = false;
            exchangeButtons.forEach(b => { if (b) b.disabled = false; });
          }, ms);
        }
      };
    }

    // Single draw handler
    function singleDraw(){
      const name = weightedDrawName();
      updateZodiacCount(name);
      pushHistory({ type: 'æŠ½å–', name, time: new Date().toLocaleTimeString() });
      increaseCost(1);
      subtitle.textContent = `ä½ æŠ½åˆ°äº† ${name}ï¼`;
      if (!panelRecord.hidden) { renderCounts(); renderHistory(); renderSummaryCost(); renderExchangeCounts(); }
    }

    // Ten-draw handler
    function tenDraw(){
      const results = [];
      for (let i = 0; i < 10; i++){
        const name = weightedDrawName();
        updateZodiacCount(name);
        pushHistory({ type: 'æŠ½å–', name, time: new Date().toLocaleTimeString() });
        results.push(name);
      }
      increaseCost(10);
      subtitle.textContent = `ä½ é€£çºŒæŠ½äº† 10 æ¬¡ã€‚`;
      if (!panelRecord.hidden) { renderCounts(); renderHistory(); renderSummaryCost(); renderExchangeCounts(); }
    }

    // Hundred-draw handler
    function hundredDraw(){
      const results = [];
      for (let i = 0; i < 100; i++){
        const name = weightedDrawName();
        updateZodiacCount(name);
        pushHistory({ type: 'æŠ½å–', name, time: new Date().toLocaleTimeString() });
        results.push(name);
      }
      increaseCost(100);
      subtitle.textContent = `ä½ é€£çºŒæŠ½äº† 100 æ¬¡ã€‚`;
      if (!panelRecord.hidden) { renderCounts(); renderHistory(); renderSummaryCost(); renderExchangeCounts(); }
    }

    // Bind draw events
    btn.addEventListener('click', withTemporaryDisable(singleDraw, 220));
    btn10.addEventListener('click', withTemporaryDisable(tenDraw, 420));
    btn100.addEventListener('click', withTemporaryDisable(hundredDraw, 1200));

    // Redeem button (ç¤ºæ„)
    document.getElementById('redeemBtn').addEventListener('click', () => {
      subtitle.textContent = 'å…Œæ›åŠŸèƒ½è«‹è‡³ã€Œå…Œæ›ã€é ç±¤æ“ä½œ';
    });

    // Clear history
    clearHistoryBtn.addEventListener('click', () => {
      history.length = 0;
      for (const k of Object.keys(counts)) counts[k] = 0;
      for (const r of Object.keys(rewardsCounts)) rewardsCounts[r] = 0;
      zodiacItems.forEach(item => item.querySelector('.note').textContent = '0å€‹');
      totalCost = 0;
      totalCostEl.textContent = formatCurrency(totalCost);
      subtitle.textContent = 'å·²æ¸…é™¤ç´€éŒ„èˆ‡æ•¸é‡';
      renderCounts();
      renderHistory();
      renderSummaryCost();
      renderExchangeCounts();
    });

    // Exchange logic
    function consumeDistinctRandom(namesNeeded){
      const owned = getOwnedDistinctNames();
      if (owned.length < namesNeeded) return null;
      const shuffled = owned.slice().sort(() => Math.random() - 0.5);
      const chosen = shuffled.slice(0, namesNeeded);
      chosen.forEach(n => decreaseZodiacCount(n));
      return chosen;
    }

    function pickBoxReward(boxKey){
      const box = boxDefinitions[boxKey];
      if (!box) return null;
      const idx = Math.floor(Math.random() * box.rewards.length);
      return box.rewards[idx];
    }

    function exchangeBox(boxKey){
      const box = boxDefinitions[boxKey];
      if (!box) return;
      const need = box.require;
      const ownedDistinct = getOwnedDistinctNames().length;
      if (ownedDistinct < need) {
        exchangeResultEl.textContent = `æŒæœ‰ä¸åŒç”Ÿè‚–ä¸è¶³ï¼šéœ€è¦ ${need} ç¨®ä¸åŒç”Ÿè‚–ï¼Œç›®å‰åªæœ‰ ${ownedDistinct} ç¨®ã€‚`;
        return;
      }
      const consumed = consumeDistinctRandom(need);
      if (!consumed) {
        exchangeResultEl.textContent = 'æ¶ˆè€—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
        return;
      }
      const reward = pickBoxReward(boxKey);
      rewardsCounts[reward] = (rewardsCounts[reward] || 0) + 1;
      const time = new Date().toLocaleTimeString();
      pushHistory({ type: 'å…Œæ›', name: `${boxKey}ç®± â†’ ${reward}`, time });
      exchangeResultEl.innerHTML = `<strong>å…Œæ›æˆåŠŸ</strong>ï¼ˆæ¶ˆè€—ï¼š${consumed.join('ã€')}ï¼‰<br>ç²å¾—ï¼š<span style="color:#ffdca8">${reward}</span>`;
      renderCounts();
      renderHistory();
      renderSummaryCost();
      renderExchangeCounts();
    }

    // Bind exchange buttons with protection
    const exchangeBtnEls = [
      document.getElementById('exchangeSuper'),
      document.getElementById('exchangeGreat'),
      document.getElementById('exchangeMedium'),
      document.getElementById('exchangeSmall')
    ];
    exchangeBtnEls.forEach(btnEl => {
      if (!btnEl) return;
      btnEl.addEventListener('click', withTemporaryDisable(() => {
        const boxKey = btnEl.dataset.box;
        exchangeBox(boxKey);
      }, 500));
    });

    // Initial render
    totalCostEl.textContent = formatCurrency(totalCost);
    renderCounts();
    renderHistory();
    renderSummaryCost();
    renderExchangeCounts();
  </script>
</body>
</html>
